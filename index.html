<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NaviC Satellite Tracking System | ISRO</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1c2128;
            --accent-cyan: #58a6ff;
            --accent-orange: #ff7b72;
            --accent-green: #3fb950;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --text-muted: #484f58;
            --border-default: #30363d;
            --border-muted: #21262d;
            --warning: #d29922;
            --error: #f85149;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            line-height: 1.5;
            font-size: 14px;
        }

        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 6px;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-default);
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-orange) 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand-text h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .brand-text p {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .header-nav {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: var(--bg-primary);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Status Banner */
        .status-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.warning {
            background: var(--warning);
        }

        .status-dot.error {
            background: var(--error);
        }

        .status-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* Card Component */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .card-body {
            padding: 20px;
        }

        /* Canvas Visualization */
        #satelliteCanvas {
            width: 100%;
            height: 450px;
            background: var(--bg-primary);
            border-radius: 4px;
            display: block;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-default);
            background: var(--bg-tertiary);
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .btn-primary {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: #4184e4;
            border-color: #4184e4;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .metric-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 14px;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .metric-value.highlight {
            color: var(--accent-cyan);
        }

        /* Terminal */
        .terminal {
            background: var(--bg-primary);
            border-radius: 4px;
            height: 320px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
        }

        .terminal-line {
            margin-bottom: 4px;
            line-height: 1.6;
        }

        .terminal-line.info {
            color: var(--accent-cyan);
        }

        .terminal-line.success {
            color: var(--accent-green);
        }

        .terminal-line.warning {
            color: var(--warning);
        }

        .terminal-line.error {
            color: var(--error);
        }

        .terminal-line.muted {
            color: var(--text-muted);
        }

        /* Map */
        #map {
            height: 450px;
            width: 100%;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .map-loading {
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        /* Footer */
        footer {
            margin-top: 40px;
            padding: 24px;
            border-top: 1px solid var(--border-default);
            text-align: center;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .footer-content {
                flex-direction: column;
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .status-banner {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .header-nav {
                display: none;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="header-brand">
        <div class="brand-icon">
            <i class="fas fa-satellite"></i>
        </div>
        <div class="brand-text">
            <h1>NaviC Tracking System</h1>
            <p>Indian Regional Navigation Satellite System</p>
        </div>
    </div>
    <div class="header-nav">
        <button class="nav-btn active" id="liveTrackingBtn">
            <i class="fas fa-chart-line"></i>
            Live Tracking
        </button>
    </div>
</header>

<div class="container">
    <div class="status-banner">
        <div class="status-item">
            <div class="status-dot" id="systemStatus"></div>
            <span class="status-label">System:</span>
            <span class="status-value" id="systemStatusText">Initializing</span>
        </div>
        <div class="status-item">
            <span class="status-label">Location:</span>
            <span class="status-value" id="locationCoords">Acquiring...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Accuracy:</span>
            <span class="status-value" id="locationAccuracy">-- m</span>
        </div>
        <div class="status-item">
            <span class="status-label">System Time:</span>
            <span class="status-value" id="systemTime">--:--:--</span>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-crosshairs"></i>
                    Positional Deviation Analysis
                </div>
                <div class="card-actions">
                    <button class="icon-btn" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="satelliteCanvas"></canvas>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="startBtn" disabled>
                    <i class="fas fa-play"></i>
                    Start Simulation
                </button>
                <button class="btn" id="stopBtn" disabled>
                    <i class="fas fa-pause"></i>
                    Pause
                </button>
                <button class="btn" id="resetBtn" disabled>
                    <i class="fas fa-redo"></i>
                    Reset
                </button>
            </div>
        </div>

        <div>
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Performance Metrics
                    </div>
                </div>
                <div class="card-body">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Current Deviation</div>
                            <div class="metric-value highlight" id="deviationValue">0.00 m</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Position Accuracy</div>
                            <div class="metric-value" id="positionAccuracy">100%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Simulation Step</div>
                            <div class="metric-value" id="stepValue">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sample Rate</div>
                            <div class="metric-value">1.0 Hz</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-terminal"></i>
                        Telemetry Console
                    </div>
                    <div class="card-actions">
                        <button class="icon-btn" title="Clear" id="clearTelemetryBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="terminal" id="telemetry">
                        <div class="terminal-line info">[SYSTEM] NaviC tracking system initialized</div>
                        <div class="terminal-line muted">[INFO] Acquiring user location data...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card grid-full">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-map-marked-alt"></i>
                Geographic Position Tracking
            </div>
            <div class="card-actions">
                <button class="icon-btn" title="Center" id="centerMapBtn">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
        <div class="card-body" style="padding: 0;">
            <div id="map"></div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-content">
        <div class="footer-brand">
            <i class="fas fa-rocket"></i>
            Indian Space Research Organisation
        </div>
        <div>NaviC Satellite Tracking System v1.0.2</div>
    </div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDZUJyKhOyaDKuA3G7qQVyxWzz0b0bL_4o",
        authDomain: "navic-aim28.firebaseapp.com",
        projectId: "navic-aim28",
        storageBucket: "navic-aim28.firebasestorage.app",
        messagingSenderId: "613266393719",
        appId: "1:613266393719:web:0fd9e678f05f9a636b9472"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global State
    let userLocation = null;
    let map = null;
    let trueMarker = null;
    let deviationMarker = null;
    let pathPolyline = null;
    
    // DOM Elements
    const canvas = document.getElementById("satelliteCanvas");
    const ctx = canvas.getContext("2d");
    const telemetry = document.getElementById("telemetry");
    const systemStatus = document.getElementById("systemStatus");
    const systemStatusText = document.getElementById("systemStatusText");
    const locationCoords = document.getElementById("locationCoords");
    const locationAccuracy = document.getElementById("locationAccuracy");
    const systemTime = document.getElementById("systemTime");
    const deviationValue = document.getElementById("deviationValue");
    const positionAccuracy = document.getElementById("positionAccuracy");
    const stepValue = document.getElementById("stepValue");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");
    const clearTelemetryBtn = document.getElementById("clearTelemetryBtn");
    const centerMapBtn = document.getElementById("centerMapBtn");

    // Simulation Parameters
    const CENTER = { x: 0, y: 0 };
    const MAX_DEVIATION = 50;
    const SCALE = 4;
    let points = [];
    let step = 0;
    let running = false;
    let animationId;

    // Set canvas size
    function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = 450;
        CENTER.x = canvas.width / 2;
        CENTER.y = canvas.height / 2;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // System Time Update
    function updateSystemTime() {
        const now = new Date();
        const hours = String(now.getUTCHours()).padStart(2, '0');
        const minutes = String(now.getUTCMinutes()).padStart(2, '0');
        const seconds = String(now.getUTCSeconds()).padStart(2, '0');
        systemTime.textContent = `${hours}:${minutes}:${seconds} UTC`;
    }
    setInterval(updateSystemTime, 1000);
    updateSystemTime();

    // Add Terminal Line
    function addLog(message, type = 'muted') {
        const line = document.createElement('div');
        line.className = `terminal-line ${type}`;
        line.textContent = message;
        telemetry.appendChild(line);
        
        while (telemetry.children.length > 50) {
            telemetry.removeChild(telemetry.firstChild);
        }
        
        telemetry.scrollTop = telemetry.scrollHeight;
    }

    // Clear telemetry console
    clearTelemetryBtn.addEventListener('click', () => {
        telemetry.innerHTML = '';
        addLog('[SYSTEM] Telemetry console cleared', 'info');
    });

    // Get User Location
    function getUserLocation() {
        addLog('[SYSTEM] Requesting geolocation permissions...', 'info');
        systemStatusText.textContent = 'Acquiring Location';
        systemStatus.className = 'status-dot warning';
        
        if (!navigator.geolocation) {
            addLog('[ERROR] Geolocation not supported by browser', 'error');
            systemStatus.className = 'status-dot error';
            useDefaultLocation();
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            position => {
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    alt: position.coords.altitude || 0,
                    accuracy: position.coords.accuracy
                };
                
                locationCoords.textContent = `${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}`;
                locationAccuracy.textContent = `${userLocation.accuracy.toFixed(1)} m`;
                
                addLog(`[SUCCESS] Location acquired: ${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}`, 'success');
                addLog(`[INFO] Accuracy: ${userLocation.accuracy.toFixed(2)} meters`, 'info');
                
                systemStatusText.textContent = 'Online';
                systemStatus.className = 'status-dot';
                
                initializeMap();
                initializeSimulation();
                
                startBtn.disabled = false;
                stopBtn.disabled = false;
                resetBtn.disabled = false;
            },
            error => {
                let msg = '[ERROR] Location error: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        msg += 'Permission denied';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        msg += 'Position unavailable';
                        break;
                    case error.TIMEOUT:
                        msg += 'Request timeout';
                        break;
                }
                
                addLog(msg, 'error');
                systemStatus.className = 'status-dot error';
                useDefaultLocation();
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // Default Location Fallback
    function useDefaultLocation() {
        addLog('[WARNING] Using default location (Central India)', 'warning');
        
        userLocation = {
            lat: 20.5937,
            lon: 78.9629,
            alt: 0,
            accuracy: 1000
        };
        
        locationCoords.textContent = `${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}`;
        locationAccuracy.textContent = 'Default';
        
        systemStatusText.textContent = 'Limited Mode';
        systemStatus.className = 'status-dot warning';
        
        initializeMap();
        initializeSimulation();
        
        startBtn.disabled = false;
        stopBtn.disabled = false;
        resetBtn.disabled = false;
    }

    // Initialize Map
    function initializeMap() {
        map = L.map('map', {
            center: [userLocation.lat, userLocation.lon],
            zoom: 16,
            zoomControl: true
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        trueMarker = L.circleMarker([userLocation.lat, userLocation.lon], {
            radius: 8,
            color: '#58a6ff',
            fillColor: '#58a6ff',
            fillOpacity: 0.8,
            weight: 2
        }).addTo(map).bindPopup(`
            <strong>Reference Position</strong><br>
            Lat: ${userLocation.lat.toFixed(6)}<br>
            Lon: ${userLocation.lon.toFixed(6)}<br>
            Alt: ${userLocation.alt.toFixed(1)} m
        `);

        pathPolyline = L.polyline([], {
            color: '#ff7b72',
            weight: 2,
            opacity: 0.6
        }).addTo(map);
        
        addLog('[SUCCESS] Map initialized successfully', 'success');
    }

    // Initialize Simulation Canvas
    function initializeSimulation() {
        drawGrid();
        drawReferencePoint();
        addLog('[SUCCESS] Simulation ready to start', 'success');
    }

    // Draw Grid Background
    function drawGrid() {
        ctx.strokeStyle = 'rgba(48, 54, 61, 0.5)';
        ctx.lineWidth = 1;
        
        const gridSize = 50;
        for (let x = 0; x < canvas.width; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
        
        for (let y = 0; y < canvas.height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
    }

    // Draw Reference Point
    function drawReferencePoint() {
        ctx.beginPath();
        ctx.arc(CENTER.x, CENTER.y, 10, 0, Math.PI * 2);
        ctx.fillStyle = '#58a6ff';
        ctx.fill();
        ctx.strokeStyle = '#1c2128';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.strokeStyle = '#58a6ff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(CENTER.x - 20, CENTER.y);
        ctx.lineTo(CENTER.x + 20, CENTER.y);
        ctx.moveTo(CENTER.x, CENTER.y - 20);
        ctx.lineTo(CENTER.x, CENTER.y + 20);
        ctx.stroke();
    }

    // Generate Random Deviation
    function generateDeviation() {
        const distance = Math.random() * MAX_DEVIATION;
        const angle = Math.random() * 2 * Math.PI;
        const dx = distance * Math.cos(angle);
        const dy = distance * Math.sin(angle);
        return {
            x: CENTER.x + dx * SCALE,
            y: CENTER.y + dy * SCALE,
            distance,
            dx,
            dy
        };
    }

    // Draw Deviation Point
    function drawPoint(p, color = '#ff7b72') {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = '#1c2128';
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    // Draw Path Between Points
    function drawPath() {
        if (points.length < 2) return;
        
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.strokeStyle = 'rgba(255, 123, 114, 0.3)';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    // Format date for telemetry
    function formatTelemetryDate(date) {
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const minutes = String(date.getUTCMinutes()).padStart(2, '0');
        const seconds = String(date.getUTCSeconds()).padStart(2, '0');
        
        return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
    }

    // Update Map Visualization
    function updateMap(dx, dy, point) {
        if (!userLocation) return;
        
        const deltaLat = dy / 111320;
        const deltaLon = dx / (111320 * Math.cos(userLocation.lat * Math.PI / 180));
        const newLat = userLocation.lat + deltaLat;
        const newLon = userLocation.lon + deltaLon;
        
        // Generate random satellite data
        const satellites = Math.floor(Math.random() * 4) + 6; // 6-9 satellites
        const hdop = (Math.random() * 0.5 + 1.3).toFixed(2); // 1.3-1.8 HDOP
        const confidence = (Math.random() * 0.15 + 0.8).toFixed(2); // 0.8-0.95 confidence

        if (deviationMarker) {
            deviationMarker.setLatLng([newLat, newLon]);
        } else {
            deviationMarker = L.circleMarker([newLat, newLon], {
                radius: 6,
                color: '#ff7b72',
                fillColor: '#ff7b72',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map).bindPopup(`
                <strong>Deviated Position</strong><br>
                Deviation: ${point.distance.toFixed(2)} m
            `);
        }

        pathPolyline.addLatLng([newLat, newLon]);

        deviationValue.textContent = `${point.distance.toFixed(2)} m`;
        const accuracy = ((MAX_DEVIATION - point.distance) / MAX_DEVIATION * 100).toFixed(1);
        positionAccuracy.textContent = `${accuracy}%`;
        stepValue.textContent = step + 1;

        // Add telemetry in the requested format
        const now = new Date();
        addLog(`Time (UTC): ${formatTelemetryDate(now)}`, 'info');
        addLog(`RAW  Lat,Lon,Alt : ${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}, ${userLocation.alt.toFixed(2)} m`, 'muted');
        addLog(`Sats: ${satellites}  HDOP: ${hdop}`, 'muted');
        addLog(`Predicted offsets (meters) -> dx(East)=${dx.toFixed(3)}  dy(North)=${dy.toFixed(3)}  conf=${confidence}`, 'info');
        addLog(`CORR  Lat,Lon,Alt : ${newLat.toFixed(6)}, ${newLon.toFixed(6)}, ${userLocation.alt.toFixed(2)} m`, 'success');
        addLog(`Applied correction magnitude: ${point.distance.toFixed(3)} m`, 'info');
        addLog(`Note: For real 15-min steps set SIM_STEP_MS = 900000 (15*60*1000)`, 'warning');
        addLog('---', 'muted');

        // Send to Firebase
        db.collection("telemetry").add({
            step: step + 1,
            timestamp: firebase.firestore.Timestamp.now(),
            userLocation: userLocation,
            deviation: { dx, dy, distance: point.distance },
            correctedPosition: { lat: newLat, lon: newLon },
            accuracy: parseFloat(accuracy),
            satellites: satellites,
            hdop: parseFloat(hdop),
            confidence: parseFloat(confidence)
        }).catch(err => {
            console.error("Firebase error:", err);
        });
    }

    // Main Simulation Loop
    function simulate() {
        if (!running || !userLocation) return;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        drawGrid();
        drawReferencePoint();
        drawPath();
        
        points.forEach(p => drawPoint(p));
        
        const newPoint = generateDeviation();
        points.push(newPoint);
        drawPoint(newPoint);
        
        updateMap(newPoint.dx, newPoint.dy, newPoint);
        
        step++;
        if (points.length > 30) points.shift();
        
        animationId = requestAnimationFrame(() => setTimeout(simulate, 1000));
    }

    // Control Handlers
    startBtn.onclick = () => {
        if (!running && userLocation) {
            running = true;
            systemStatusText.textContent = 'Tracking Active';
            addLog('[SUCCESS] Simulation started', 'success');
            simulate();
        }
    };

    stopBtn.onclick = () => {
        if (running) {
            running = false;
            cancelAnimationFrame(animationId);
            systemStatusText.textContent = 'Paused';
            addLog('[WARNING] Simulation paused', 'warning');
        }
    };

    resetBtn.onclick = () => {
        running = false;
        cancelAnimationFrame(animationId);
        step = 0;
        points = [];
        
        if (pathPolyline) pathPolyline.setLatLngs([]);
        if (deviationMarker) {
            map.removeLayer(deviationMarker);
            deviationMarker = null;
        }
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid();
        drawReferencePoint();
        
        systemStatusText.textContent = 'Online';
        deviationValue.textContent = '0.00 m';
        positionAccuracy.textContent = '100%';
        stepValue.textContent = '0';
        
        addLog('[INFO] Simulation reset', 'info');
    };

    // Center map on current location
    centerMapBtn.addEventListener('click', () => {
        if (map && userLocation) {
            map.setView([userLocation.lat, userLocation.lon], 16);
            addLog('[INFO] Map centered on current location', 'info');
        }
    });

    // Initialize Application
    getUserLocation();

    // Live Tracking Button - Scroll to Map and Center on Current Location
    const liveTrackingBtn = document.getElementById('liveTrackingBtn');
    liveTrackingBtn.addEventListener('click', () => {
        const mapCard = document.querySelector('.card.grid-full');
        if (mapCard) {
            mapCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Center map on current location with animation
        if (map && userLocation) {
            map.flyTo([userLocation.lat, userLocation.lon], 18, {
                duration: 1.5,
                easeLinearity: 0.5
            });
            
            // Open popup on true marker to highlight location
            if (trueMarker) {
                setTimeout(() => {
                    trueMarker.openPopup();
                }, 1600);
            }
            
            addLog('[SUCCESS] Map centered on current location', 'success');
        }
    });
</script>
</body>
</html>